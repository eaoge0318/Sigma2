# 01. è¯¦ç»†æ¶æ„è®¾è®¡

## ç³»ç»Ÿæ¶æ„æ€»è§ˆ

### ğŸš€ æ ¸å¿ƒè¨­è¨ˆå“²å­¸ï¼šæ‰“ç ´ã€Œå–®å‘åˆ†æã€

æœ¬æ¶æ§‹çš„æ ¸å¿ƒæ”¹è‰¯åœ¨æ–¼å¾èˆŠç‰ˆçš„ **ã€Œå–®å‘ç·šæ€§æµç¨‹ã€** è½‰åŒ–ç‚º **ã€Œå¾ªç’°è¿­ä»£æµç¨‹ã€**ã€‚

*   **ç¾ç‹€å•é¡Œ**ï¼šAI æŠ“å–ä¸€æ¬¡è³‡æ–™å¾Œå°±å¿…é ˆå¯«çµè«–ï¼Œå°è‡´ã€Œé‚è¼¯è·³èºã€ä¸”å…§å®¹ç©ºæ´ã€‚
*   **v2.0 è§£æ±ºæ–¹æ¡ˆï¼šèºæ—‹å¼æ¨ç†å¾ªç’° (Iterative Reasoning Loop)**ï¼š
    *   **å¤šæ­¥é€£çºŒèª¿ç”¨ (Multi-turn Tool Usage)**ï¼šå…·å‚™ã€Œå…ˆçœ‹ç›®éŒ„ã€å†æŠ“æ•¸æ“šã€å¾Œåšæ¯”è¼ƒã€çš„æ·±åº¦åˆ†æéˆæ¢ï¼Œä¸é™åˆ¶å–®æ¬¡å·¥å…·èª¿ç”¨ã€‚
    *   **æ¨ç†æš«å­˜èˆ‡ç­–ç•¥ (Internal Monologue)**ï¼šAI åœ¨æ¯æ­¥åŸ·è¡Œå‰éœ€è¼¸å‡ºæ€ç¶­éˆï¼ˆCoTï¼‰ï¼Œæ˜ç¢ºå…¶åˆ†æç­–ç•¥ã€‚
    *   **è‡ªæˆ‘ä¿®æ­£èˆ‡çµè«–æ ¡é©— (Self-Correction)**ï¼šåœ¨æ’°å¯«çµè«–å‰ï¼Œç”±ç³»çµ±è‡ªå‹•æ ¸å°æ˜¯å¦æœ‰å¯¦è³ªæ•¸æ“šæ”¯æŒã€‚

---

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å‰ç«¯å±‚ (Frontend)                  â”‚
â”‚                                                      â”‚
â”‚  dashboard.html + intelligent_analysis.js            â”‚
â”‚  - æ–‡ä»¶é€‰æ‹©                                           â”‚
â”‚  - å¯¹è¯ç•Œé¢                                           â”‚
â”‚  - ç»“æœå±•ç¤º                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ HTTP/JSON
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 API å±¤ (Router)                      â”‚
â”‚                                                      â”‚
â”‚  analysis_router.py                                  â”‚
â”‚  - /prepare         (ç´¢å¼•å»ºç«‹)                       â”‚
â”‚  - /chat/stream     (Workflow é©…å‹•)                  â”‚
â”‚  - /stop_generation (ä¸­æ–·ä¿¡è™Ÿ)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Analysis      â”‚           â”‚ Analysis        â”‚
â”‚  Workflow      â”‚           â”‚ Service         â”‚
â”‚  (LlamaIndex)  â”‚           â”‚                 â”‚
â”‚  agent.py      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ - ç´¢å¼•å»ºç«‹      â”‚
â”‚  - äº‹ä»¶é©…å‹•      â”‚           â”‚ - æ•¸æ“šæ‘˜è¦      â”‚
â”‚  - ç‹€æ…‹æ©Ÿç®¡ç†    â”‚           â”‚ - èªç¾©æœç´¢      â”‚
â”‚  - æ„åœ–åˆ†æµ      â”‚           â”‚ - åœæ­¢ä¿¡è™Ÿç®¡ç†  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                             â”‚
        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Tool Executor (å·¥å…·æ‰§è¡Œå™¨)              â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Query    â”‚ Stats    â”‚ Pattern  â”‚ Helper   â”‚     â”‚
â”‚  â”‚ Tools    â”‚ Tools    â”‚ Tools    â”‚ Tools    â”‚     â”‚
â”‚  â”‚ (5ä¸ª)    â”‚ (6ä¸ª)    â”‚ (4ä¸ª)    â”‚ (3ä¸ª)    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ•°æ®å±‚ (Storage)                     â”‚
â”‚                                                      â”‚
â”‚  workspace/{session_id}/                             â”‚
â”‚  â”œâ”€â”€ uploads/{filename}.csv     (åŸå§‹æ•°æ®)           â”‚
â”‚  â””â”€â”€ analysis/{file_id}/        (ç´¢å¼•ä¸ç¼“å­˜)         â”‚
â”‚      â”œâ”€â”€ summary.json                                â”‚
â”‚      â”œâ”€â”€ statistics.json                             â”‚
â”‚      â”œâ”€â”€ correlations.json                           â”‚
â”‚      â””â”€â”€ semantic_index.json                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¤–éƒ¨ä¾è³´:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ollama API    â”‚  http://localhost:11434/api/chat
â”‚  (llama3)      â”‚  é€é LlamaIndex LLM å¥—ä»¶é€£æ¥
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LlamaIndex    â”‚  æ ¸å¿ƒ Agent æ¡†æ¶
â”‚  Framework     â”‚  æä¾› ReAct é‹ä½œé‚è¼¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ¨¡å—åˆ†å±‚è®¾è®¡

### Layer 1: æ•°æ®å¤„ç†å±‚

**æ–‡ä»¶**: `analysis_service.py` (350è¡Œ)

**èŒè´£**:
- CSV æ–‡ä»¶è§£æä¸éªŒè¯
- æ•°æ®ç´¢å¼•å»ºç«‹ï¼ˆä¸€æ¬¡æ€§ï¼‰
- ç»Ÿè®¡ä¿¡æ¯é¢„è®¡ç®—
- ç»Ÿè®¡ä¿¡æ¯é¢„è®¡ç®—
- è¯­ä¹‰ç´¢å¼•æ„å»º
- ç”Ÿæˆæ§åˆ¶ (åœæ­¢ä¿¡è™Ÿç®¡ç†)

**æ ¸å¿ƒæ–¹æ³•**:
```python
class AnalysisService:
    async def build_analysis_index(csv_path, session_id, filename) -> Dict
    def get_analysis_path(session_id, file_id) -> Path
    def _categorize_parameters(columns) -> Dict
    def _build_semantic_index(columns) -> Dict
```

---

### Layer 2: å·¥å…·å±‚

**ç›®å½•**: `analysis/tools/` (6ä¸ªæ–‡ä»¶ï¼Œå…±930è¡Œ)

#### 2.1 åŸºç±» (`base.py`, 50è¡Œ)

```python
class AnalysisTool(ABC):
    """æ‰€æœ‰å·¥å…·çš„æŠ½è±¡åŸºç±»"""
    
    @property
    @abstractmethod
    def name(self) -> str: pass
    
    @property
    @abstractmethod
    def description(self) -> str: pass
    
    @abstractmethod
    def execute(self, params: Dict, session_id: str) -> Dict: pass
```

#### 2.2 æŸ¥è¯¢å·¥å…· (`data_query.py`, 200è¡Œ)

- GetParameterList
- GetParameterStatistics
- GetDataOverview
- SearchParametersByConcept
- GetTimeSeriesData

#### 2.3 ç»Ÿè®¡å·¥å…· (`statistics.py`, 250è¡Œ)

- CalculateCorrelation
- GetTopCorrelations
- CompareGroups
- DetectOutliers
- AnalyzeDistribution
- PerformRegression

#### 2.4 æ¨¡å¼å·¥å…· (`patterns.py`, 200è¡Œ)

- FindTemporalPatterns
- FindEventPatterns
- ClusterAnalysis
- FindAssociationRules

#### 2.5 è¾…åŠ©å·¥å…· (`helpers.py`, 100è¡Œ)

- ExplainResult
- SuggestNextAnalysis
- AskClarification

#### 2.6 æ‰§è¡Œå™¨ (`executor.py`, 100è¡Œ)

```python
class ToolExecutor:
    """ç»Ÿä¸€çš„å·¥å…·æ‰§è¡Œå…¥å£"""
    
    def __init__(self, analysis_service):
        self.tools = self._register_tools()
    
    def execute_tool(self, tool_name: str, params: Dict, session_id: str) -> Dict:
        tool = self.tools.get(tool_name)
        if not tool:
            return {"error": f"Tool not found: {tool_name}"}
        return tool.execute(params, session_id)
```

---

### Layer 3: æ™ºèƒ½å±¤ (LlamaIndex Workflow)

**æ–‡ä»¶**: `agent.py` (æ”¹ç‰ˆç‚º Workflow æ¶æ§‹)

**è·è²¬**:
- ä½¿ç”¨ LlamaIndex `Workflow` æ¡†æ¶å¯¦ä½œç‹€æ…‹æ©Ÿã€‚
- **äº‹ä»¶é©…å‹•**: é€é `Event` å‚³éæ•¸æ“šï¼Œä¸¦å…·å‚™å°è©±è¨˜æ†¶åŠŸèƒ½ã€‚
- **è‡ªä¸»ç³¾éŒ¯**: ç•¶æœå°‹å¤±æ•—æ™‚ï¼Œè‡ªå‹•é€²å…¥èªç¾©æ“´å±•å¾ªç’°é€²è¡Œé‡è©¦ã€‚
- **åœ°ç«¯å„ªå…ˆ**: é‹ç®—ç™¾åˆ†ä¹‹ç™¾åœ¨åœ°ç«¯åŸ·è¡Œã€‚

**æ ¸å¿ƒé‚è¼¯ (æ ¸å¿ƒå·¥ä½œç«™)**:
```python
class SigmaAnalysisWorkflow(Workflow):
    @step
    async def route_intent(self, ev: StartEvent) -> IntentEvent | ErrorEvent:
        # ä½¿ç”¨ LLM è¾¨è­˜æ„åœ– (Analysis / Translation / Chat)
        ...

    @step
    async def execute_analysis(self, ev: AnalysisEvent) -> VisualizingEvent | ConceptExpansionEvent:
        # åœ°ç«¯å·¥å…·åŸ·è¡Œã€‚è‹¥æœå°‹çµæœç‚ºç©ºï¼Œæ‹‹å‡º ConceptExpansionEvent
        ...

    @step
    async def visualize_data(self, ev: VisualizingEvent) -> SummarizeEvent:
        # [æ™ºæ…§åœ–è¡¨å·¥å» ]ï¼šæ ¹æ“šæ•¸æ“šç‰¹å¾µè‡ªå‹•é¸æ“‡ï¼š
        # 1. è¶¨å‹¢åœ– (Line) + é›™è»¸è‡ªå‹•åµæ¸¬
        # 2. ç›´æ–¹åœ– (Bar) + è‡ªå‹•åˆ†ç®±
        # 3. æ•£ä½ˆåœ– (Scatter) + X-Y é…å°
        ...

    @step
    async def humanizer(self, ev: SummarizeEvent) -> StopEvent:
        # çµæœç¸½çµç«™ï¼šå°ˆæ³¨æ–¼ç”Ÿæˆç¹é«”ä¸­æ–‡åˆ†æå ±å‘Š
        ...

---

## 3.3 ExpandConcept å·¥ä½œç«™ (è‡ªæˆ‘åµéŒ¯èˆ‡å¾ªç’°)

é€™æ˜¯æœ¬ç³»çµ±å¯¦ç¾ã€Œæ™ºæ…§åŒ–ã€çš„æ ¸å¿ƒå·¥ä½œç«™ã€‚å…¶é‹ä½œé‚è¼¯å¦‚ä¸‹ï¼š

1.  **è§¸ç™¼æ¢ä»¶**ï¼šç•¶ `execute_analysis` æ­¥é©ŸåŸ·è¡Œå·¥å…·å¾Œï¼Œå¦‚æœè¿”å›çµæœç‚ºç©ºï¼ˆä¾‹å¦‚é—œéµå­—æœå°‹é›¶åŒ¹é…ï¼‰ï¼Œä¸”è©²è«‹æ±‚å…·å‚™èªç¾©æ“´å±•çš„å¯èƒ½æ€§ã€‚
2.  **é‚è¼¯è™•ç†**ï¼š
    *   **ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼šè®€å–ç•¶å‰ `query` èˆ‡æª”æ¡ˆ `summary`ã€‚
    *   **é ˜åŸŸè¯æƒ³**ï¼šåˆ©ç”¨ LLM çš„å°ˆå®¶çŸ¥è­˜ï¼Œé‡å°ç”¨æˆ¶çš„æ¨¡ç³Šè©å½™ï¼ˆå¦‚ã€Œæ–·ç´™ã€ï¼‰è¯æƒ³å‡ºå¤šå€‹å·¥æ¥­å°æ‡‰è©ï¼ˆå¦‚ `WEB_BREAK`, `PaperBreak`, `STOP_PAGE`ï¼‰ã€‚
    *   **é–‰ç’°é‡è©¦**ï¼šæ‹‹å‡ºä¸€å€‹å¸¶æœ‰æ–°é—œéµå­—çš„ `AnalysisEvent`ï¼Œè®“ Workflow å›åˆ°åˆ†æç«™é‡æ–°åŸ·è¡Œã€‚
3.  **ç›®æ¨™**ï¼šå°‡ã€Œå¤±æ•—çš„æœå°‹ã€è½‰åŒ–ç‚ºã€ŒæˆåŠŸçš„åˆ†æã€ï¼Œå¯¦ç¾åˆ†æé‚è¼¯çš„è‡ªæˆ‘ä¿®å¾©ã€‚

---
```

---

### Layer 4: APIå±‚

**æ–‡ä»¶**: `analysis_router.py` (200è¡Œ)

**ç«¯ç‚¹è®¾è®¡**:

| ç«¯ç‚¹ | æ–¹æ³• | ç”¨é€” |
|------|------|------|
| `/api/analysis/prepare` | POST | å»ºç«‹æ–‡ä»¶ç´¢å¼• |
| `/api/analysis/chat` | POST | æ™ºèƒ½å¯¹è¯ |
| `/api/analysis/chat/stream` | POST | ä¸²æµå¯¹è¯ |
| `/api/analysis/stop_generation` | POST | åœæ­¢ç”Ÿæˆ |
| `/api/analysis/files` | GET | æ–‡ä»¶åˆ—è¡¨ |
| `/api/analysis/summary/{file_id}` | GET | æ–‡ä»¶æ‘˜è¦ |
| `/api/analysis/clear-session` | DELETE | æ¸…é™¤ä¼šè¯ |
| `/api/analysis/tools` | GET | å·¥å…·åˆ—è¡¨ |

---

## æ•°æ®æµè®¾è®¡

### æµç¨‹ 1: æ–‡ä»¶å‡†å¤‡

```
ç”¨æˆ·ä¸Šä¼  CSV
    â†“
å‰ç«¯: é€‰æ‹©æ–‡ä»¶ â†’ ç‚¹å‡»"å‡†å¤‡ç´¢å¼•"
    â†“
API: POST /api/analysis/prepare
    â†“
AnalysisService.build_analysis_index()
    â”œâ”€ è¯»å– CSV
    â”œâ”€ è®¡ç®—åŸºæœ¬ç»Ÿè®¡ â†’ statistics.json
    â”œâ”€ è®¡ç®—ç›¸å…³æ€§çŸ©é˜µ â†’ correlations.json
    â”œâ”€ æ„å»ºè¯­ä¹‰ç´¢å¼• â†’ semantic_index.json
    â””â”€ ç”Ÿæˆæ‘˜è¦ â†’ summary.json
    â†“
è¿”å›: {file_id, summary}
```

### æµç¨‹ 2: æ™ºèƒ½å°è©±èˆ‡ã€Œè‡ªæˆ‘åµéŒ¯èˆ‡åˆ†æã€å¾ªç’° (Self-Correction Cycle)

é€™æ˜¯ç³»çµ±å…·å‚™ã€Œé‚è¼¯æ·±åº¦ã€çš„æ ¸å¿ƒæ©Ÿåˆ¶ï¼Œç¢ºä¿ AI åœ¨åˆæ­¥æœå°‹å¤±æ•—æ™‚ä¸æœƒè¼•æ˜“æ”¾æ£„ï¼š

```
ç”¨æˆ¶æå•: "æœ‰æ²’æœ‰æ–·ç´™ç›¸é—œåƒæ•¸ï¼Ÿ"
    â”‚
1. æ„åœ–è­˜åˆ¥ (route_intent)
    â†’ è­˜åˆ¥ç‚º: 'analysis'
    â”‚
2. åœ°ç«¯å·¥å…·åŸ·è¡Œ (execute_analysis)
    â†’ å˜—è©¦æœå°‹ "æ–·ç´™" â†’ å¤±æ•— (0çµæœ)
    â”‚
3. [è‡ªä¸»åµéŒ¯] èªç¾©æ“´å±•å·¥ä½œç«™ (expand_concept) â”€â”€â”
    â†’ LLM è¯æƒ³: "Paper Break", "WebBreak"      â”‚
    â”‚                                          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ (è‡ªå‹•ç™¼èµ·é‡è©¦å¾ªç’°)
    â”‚
4. [å†åˆ†æ] åœ°ç«¯å·¥å…·åŸ·è¡Œ (execute_analysis)
    â†’ æœå°‹ "Paper Break" â†’ æˆåŠŸï¼
    â”‚
5. æ•¸æ“šå¯è¦–åŒ– (visualize_data)
    â†’ æ™ºæ…§åœ–è¡¨å·¥å» ï¼šè‡ªå‹•ç”Ÿæˆé…å°åœ–è¡¨ JSON
    â”‚
6. çµæœç¸½çµ (humanizer)
    â†’ ç”Ÿæˆç¹é«”ä¸­æ–‡å ±å‘Š (Expert Summary)
    â”‚
è¿”å›å‰ç«¯æ¸²æŸ“
```

> [!NOTE]
> **ExpandConcept å·¥ä½œç«™** æ˜¯å¯¦ç¾ã€Œå¾ªç’°ã€çš„é—œéµã€‚å®ƒå°‡ LLM ä½œç‚ºèªç¾©ç´¢å¼•çš„è£œå„Ÿå™¨ï¼Œå¤§å¹…æå‡äº†å°å·¥æ¥­å°ˆæ¥­è¡“èªçš„å®¹éŒ¯ç‡ã€‚

---

## æ–‡ä»¶ç»„ç»‡ç­–ç•¥

### æŒ‰åŠŸèƒ½åˆ†ç»„

```
tools/
â”œâ”€â”€ data_query.py      â† æ‰€æœ‰æŸ¥è¯¢ç±»å·¥å…·
â”œâ”€â”€ statistics.py      â† æ‰€æœ‰ç»Ÿè®¡ç±»å·¥å…·
â”œâ”€â”€ patterns.py        â† æ‰€æœ‰æ¨¡å¼ç±»å·¥å…·
â””â”€â”€ helpers.py         â† æ‰€æœ‰è¾…åŠ©ç±»å·¥å…·
```

### å‘½åè§„èŒƒ

**ç±»å**: PascalCase + Tool åç¼€
- `GetParameterListTool`
- `CalculateCorrelationTool`

**æ–‡ä»¶å**: snake_case
- `data_query.py`
- `analysis_service.py`

**æ–¹æ³•å**: snake_case
- `execute()`
- `_identify_intent()`

---

## æ‰©å±•æ€§è®¾è®¡

### æ–°å¢å·¥å…·çš„æ­¥éª¤

1. åœ¨å¯¹åº”åˆ†ç±»æ–‡ä»¶ä¸­æ–°å¢ç±»ï¼ˆç»§æ‰¿ `AnalysisTool`ï¼‰
2. å®ç° `name`, `description`, `execute` æ–¹æ³•
3. åœ¨ `executor.py` ä¸­æ³¨å†Œ
4. åœ¨ `agent.py` çš„æ„å›¾è¯†åˆ«ä¸­æ·»åŠ è§„åˆ™

**ç¤ºä¾‹**:
```python
# tools/statistics.py

class NewStatTool(AnalysisTool):
    name = "new_stat_tool"
    description = "æ–°ç»Ÿè®¡å·¥å…·"
    required_params = ['file_id']
    
    def execute(self, params, session_id):
        # å®ç°é€»è¾‘
        return {"result": "..."}
```

---

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. ç´¢å¼•ç¼“å­˜
- ç´¢å¼•æ–‡ä»¶åªç”Ÿæˆä¸€æ¬¡
- åç»­æŸ¥è¯¢ç›´æ¥è¯»å– JSON

### 2. åˆ†é¡µåŠ è½½
- å‚æ•°åˆ—è¡¨åˆ†é¡µ
- æ—¶åºæ•°æ®é‡‡æ ·

### 3. å¼‚æ­¥å¤„ç†
- ç´¢å¼•å»ºç«‹å¯æ”¹ä¸ºåå°ä»»åŠ¡ï¼ˆCeleryï¼‰
- é¿å…é˜»å¡ API å“åº”

---

## å®‰å…¨æ€§è€ƒè™‘

### 1. ç”¨æˆ·éš”ç¦»
- åŸºäº `session_id` çš„ç›®å½•éš”ç¦»
- ç”¨æˆ·Açœ‹ä¸åˆ°ç”¨æˆ·Bçš„æ•°æ®

### 2. æ–‡ä»¶éªŒè¯
- CSV æ ¼å¼éªŒè¯
- æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆ< 100MBï¼‰

### 4. è¿´åœˆèˆ‡ç„¡é™éæ­¸é˜²è­· (Loop Prevention)
- **Retry Counter**: åœ¨åˆ†æå¾ªç’°ä¸­è¨­ç½®ä¸Šé™ç‚º **5 æ¬¡**ï¼Œçµ¦äºˆ AI å……åˆ†çš„è‡ªæˆ‘ä¿®æ­£ç©ºé–“ã€‚
- **Timeout**: è¨­ç½® **600 ç§’** (10åˆ†é˜) è¶…æ™‚ï¼Œç¢ºä¿åœ°ç«¯æ¨ç†èˆ‡å¤§æ•¸æ“šé‹ç®—ä¸è¢«ä¸­æ–·ã€‚
- **Max Steps**: é™åˆ¶å–®æ¬¡å·¥ä½œæµçš„æœ€å¤§åŸ·è¡Œæ­¥æ•¸ç‚º **30 æ­¥**ã€‚

---

## ä¸‹ä¸€æ­¥

é˜…è¯» **[02_backend_modules.md](./02_backend_modules.md)** æŸ¥çœ‹å…·ä½“ä»£ç å®ç°ã€‚
